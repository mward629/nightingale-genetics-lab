<!DOCTYPE html>
<html>
<head>
    <title>Sandbox - Nightingale Genetics Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family: Arial; text-align:center;">

<h2>Sandbox Mode</h2>

<div>
    <label>Parent 1 Genotype:</label>
    <input id="p1" value="Bb">

    <label>Parent 2 Genotype:</label>
    <input id="p2" value="Bb">

    <label>Litter Size:</label>
    <input id="litter" value="8">

    <button onclick="generate()">Generate Puppies</button>
</div>

<h3>Offspring:</h3>
<div id="results"></div>

<h3>Observed Genotype Distribution</h3>
<canvas id="genotypeChart" width="400" height="200"></canvas>

<h3>Observed Phenotype Distribution</h3>
<canvas id="phenotypeChart" width="400" height="200"></canvas>

<script>
let genotypeChart;
let phenotypeChart;

async function generate() {
    const response = await fetch("/generate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            parent1: document.getElementById("p1").value,
            parent2: document.getElementById("p2").value,
            litter: document.getElementById("litter").value
        })
    });

    const data = await response.json();

    document.getElementById("results").innerText =
        data.offspring.join(", ");

    updateCharts(data.offspring);
}

function updateCharts(offspring) {

    let genotypeCounts = {};
    let phenotypeCounts = {};

    offspring.forEach(g => {

        const normalized = g.split("").sort().join("");

        genotypeCounts[normalized] =
            (genotypeCounts[normalized] || 0) + 1;

        let phenotype;
        if (normalized.includes("B")) {
            phenotype = "Black";
        } else {
            phenotype = "Brown";
        }

        phenotypeCounts[phenotype] =
            (phenotypeCounts[phenotype] || 0) + 1;
    });

    const total = offspring.length;

    // Expected genotype ratios for Bb x Bb
    const expectedGenotype = {
        "BB": total * 0.25,
        "Bb": total * 0.50,
        "bb": total * 0.25
    };

    // Expected phenotype ratios
    const expectedPhenotype = {
        "Black": total * 0.75,
        "Brown": total * 0.25
    };

    // GENOTYPE GRAPH
    const gctx = document.getElementById("genotypeChart").getContext("2d");
    if (genotypeChart) genotypeChart.destroy();

    genotypeChart = new Chart(gctx, {
        type: "bar",
        data: {
            labels: Object.keys(expectedGenotype),
            datasets: [
                {
                    label: "Observed Genotype Count",
                    data: Object.values(expectedGenotype).map(
                        (_, i) => genotypeCounts[Object.keys(expectedGenotype)[i]] || 0
                    )
                },
                {
                    label: "Expected Genotype Count",
                    data: Object.values(expectedGenotype)
                }
            ]
        },
        options: { responsive: false }
    });

    // PHENOTYPE GRAPH
    const pctx = document.getElementById("phenotypeChart").getContext("2d");
    if (phenotypeChart) phenotypeChart.destroy();

    phenotypeChart = new Chart(pctx, {
        type: "bar",
        data: {
            labels: Object.keys(expectedPhenotype),
            datasets: [
                {
                    label: "Observed Phenotype Count",
                    data: Object.values(expectedPhenotype).map(
                        (_, i) => phenotypeCounts[Object.keys(expectedPhenotype)[i]] || 0
                    )
                },
                {
                    label: "Expected Phenotype Count",
                    data: Object.values(expectedPhenotype)
                }
            ]
        },
        options: { responsive: false }
    });
}
</script>

</body>
</html>
