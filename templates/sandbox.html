<!DOCTYPE html>
<html>
<head>
    <title>Sandbox - Nightingale Genetics Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family: Arial; margin:40px;">

<h1>üß¨ Nightingale Genetics Lab</h1>
<h2>Sandbox Mode</h2>

<div style="display:flex; gap:40px; margin-bottom:40px;">

    <div style="flex:1; padding:20px; border:1px solid #ddd; border-radius:8px;">
        <h3>Cross Setup</h3>

        <label>Parent 1 Genotype:</label><br>
        <input id="p1" value="Bb"><br><br>

        <label>Parent 2 Genotype:</label><br>
        <input id="p2" value="Bb"><br><br>

        <label>Litter Size:</label><br>
        <input id="litter" value="8"><br><br>

        <button onclick="generate()" style="padding:8px 16px;">
            Generate Puppies
        </button>
        
        <br><br>
<label>
    <input type="checkbox" id="toggleExpected" checked>
    Show Expected Ratios
</label>

        <br><br>
<button onclick="resetPopulation()" style="padding:6px 12px;">
    Reset Population
</button>
    </div>

    <div style="flex:1; padding:20px; border:1px solid #ddd; border-radius:8px;">
        <h3>Offspring Genotypes</h3>
        <div id="results" style="min-height:60px;"></div>
    </div>

</div>

<div style="display:flex; gap:40px;">

<div style="flex:1;">
    <h3>Genotype Distribution</h3>
    <div style="height:400px;">
        <canvas id="genotypeChart"></canvas>
    </div>
</div>

    <div style="flex:1;">
        <h3>Phenotype Distribution</h3>
        <div style="height:400px;">
    <canvas id="phenotypeChart"></canvas>
</div>
    </div>

<div style="margin-bottom:30px; font-size:22px;">
    <strong>Total Puppies:</strong> 
    <span id="totalCount">0</span>
</div>

    <div style="margin-top:40px; border:1px solid #ddd; padding:20px; border-radius:8px;">
    <h3>Build Your Punnett Square</h3>

    <table border="1" cellpadding="10" style="margin:auto;">
        <tr>
            <td></td>
            <td><input id="top1" style="width:30px;"></td>
            <td><input id="top2" style="width:30px;"></td>
        </tr>
        <tr>
            <td><input id="side1" style="width:30px;"></td>
            <td><input id="cell1" style="width:50px;"></td>
            <td><input id="cell2" style="width:50px;"></td>
        </tr>
        <tr>
            <td><input id="side2" style="width:30px;"></td>
            <td><input id="cell3" style="width:50px;"></td>
            <td><input id="cell4" style="width:50px;"></td>
        </tr>
    </table>

    <br>
    <button onclick="checkPunnett()">Check My Square</button>
    <div id="punnettFeedback" style="margin-top:15px; font-weight:bold;"></div>
</div>
    
</div>

<script>
   let allOffspring = []; 
    let currentParents = null;
let genotypeChart;
let phenotypeChart;

async function generate() {

const p1 = document.getElementById("p1").value;
const p2 = document.getElementById("p2").value;

// Check if parents changed
if (currentParents && currentParents !== p1 + "|" + p2) {
    resetPopulation();
}

// Store current parents
currentParents = p1 + "|" + p2;
    
    const response = await fetch("/generate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            parent1: document.getElementById("p1").value,
            parent2: document.getElementById("p2").value,
            litter: document.getElementById("litter").value
        })
    });

    const data = await response.json();

    document.getElementById("results").innerText =
        data.offspring.join(", ");

    allOffspring = allOffspring.concat(data.offspring);

    document.getElementById("totalCount").innerText = allOffspring.length;

document.getElementById("results").innerText =
    allOffspring.join(", ");

updateCharts(allOffspring);
}

function updateCharts(offspring) {

    const showExpected = document.getElementById("toggleExpected").checked;

    let genotypeCounts = { "BB": 0, "Bb": 0, "bb": 0 };
    let phenotypeCounts = { "Black": 0, "Brown": 0 };

    offspring.forEach(g => {
        const normalized = g.split("").sort().join("");

        if (normalized === "BB") genotypeCounts["BB"]++;
        else if (normalized === "bb") genotypeCounts["bb"]++;
        else genotypeCounts["Bb"]++;

        if (normalized.includes("B")) phenotypeCounts["Black"]++;
        else phenotypeCounts["Brown"]++;
    });

    const total = offspring.length;

    const expectedGenotype = {
        "BB": total * 0.25,
        "Bb": total * 0.50,
        "bb": total * 0.25
    };

    const expectedPhenotype = {
        "Black": total * 0.75,
        "Brown": total * 0.25
    };

    // -------- GENOTYPE CHART --------
    const gctx = document.getElementById("genotypeChart").getContext("2d");
    if (genotypeChart) genotypeChart.destroy();

    let genotypeDatasets = [
        {
            label: "Observed",
            data: [
                genotypeCounts["BB"],
                genotypeCounts["Bb"],
                genotypeCounts["bb"]
            ]
        }
    ];

    if (showExpected) {
        genotypeDatasets.push({
            label: "Expected",
            data: [
                expectedGenotype["BB"],
                expectedGenotype["Bb"],
                expectedGenotype["bb"]
            ]
        });
    }

    genotypeChart = new Chart(gctx, {
        type: "bar",
        data: {
            labels: ["BB", "Bb", "bb"],
            datasets: genotypeDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // -------- PHENOTYPE CHART --------
    const pctx = document.getElementById("phenotypeChart").getContext("2d");
    if (phenotypeChart) phenotypeChart.destroy();

    let phenotypeDatasets = [
        {
            label: "Observed",
            data: [
                phenotypeCounts["Black"],
                phenotypeCounts["Brown"]
            ]
        }
    ];

    if (showExpected) {
        phenotypeDatasets.push({
            label: "Expected",
            data: [
                expectedPhenotype["Black"],
                expectedPhenotype["Brown"]
            ]
        });
    }

    phenotypeChart = new Chart(pctx, {
        type: "bar",
        data: {
            labels: ["Black", "Brown"],
            datasets: phenotypeDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

    function resetPopulation() {
    allOffspring = [];
    document.getElementById("results").innerText = "";

        document.getElementById("totalCount").innerText = 0;
    
    if (genotypeChart) genotypeChart.destroy();
    if (phenotypeChart) phenotypeChart.destroy();
}

    function checkPunnett() {

    const p1 = document.getElementById("p1").value;
    const p2 = document.getElementById("p2").value;

    // Generate correct combinations
    const correct = [];
    for (let a of p1) {
        for (let b of p2) {
            correct.push((a + b).split("").sort().join(""));
        }
    }

    const student = [
        document.getElementById("cell1").value,
        document.getElementById("cell2").value,
        document.getElementById("cell3").value,
        document.getElementById("cell4").value
    ].map(x => x.split("").sort().join(""));

    correct.sort();
    student.sort();

    const feedback = document.getElementById("punnettFeedback");

    if (JSON.stringify(correct) === JSON.stringify(student)) {
        feedback.innerText = "‚úÖ Correct Punnett Square!";
        feedback.style.color = "green";
    } else {
        feedback.innerText = "‚ùå Not quite right. Check allele combinations.";
        feedback.style.color = "red";
    }
}
    
</script>

</body>
</html>
